---
title: 'Data Tidying: ICPMS'
author: "James Vesto"
date: "12/16/2019"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)
```

```{r}
#Note! Before running this file you must run file 1 (01_ICPMS_data_tidying.Rmd)
ICPMS
```

1) Start by defining useful lists; such as what sites, metals, and sample IDs were analyzed.

```{r}
sample_sites <- unique(filter(ICPMS, site!="MB", site!="")$site)
#excluding method blank and quality control from the list of sites
metals_analyzed <- unique(ICPMS$metal)

#Preview the lists to check for potential issues:
#sample_sites
#metals_analyzed
```

2) Calibrating the ICPMS Data 

```{r Calibration}

ICPMS_cal <- NULL

for (unique_metal in metals_analyzed){

  cal <- ICPMS %>% 
      filter(type == "Cal1" | type== "Cal2" | type == "Cal3") %>% 
      filter(metal == unique_metal) %>%
      select(conc = concentration, signal = CPS.corrected, RSD = RSD.corrected)

  w <- 1/(cal$signal*cal$RSD)^2 
  model <- lm(cal$signal ~ cal$conc, weights= w)

  slope <- model$coefficients[2]
  intercept <- model$coefficients[1]
  slope.STD <- summary(model)$coefficients[2,2]
  intercept.STD <- summary(model)$coefficients[1,2]

  plot(cal$signal ~ cal$conc,
      xlab= paste("Concentration of ", unique_metal,"(ppb)"), #units from the standard solution prepared at OHSU (µg/L)
      ylab= "Counts per second")+ 
      abline(model, col="red")+ 
      title(paste("Calibration for", unique_metal)) 

  equation <- data.frame(metal= unique_metal, slope, slope.STD, intercept, intercept.STD)
  ICPMS_cal <- rbind(ICPMS_cal, equation)
  }

ICPMS_cal
  
  #Clearing the environment (optional, but helps to prevent accidentally using the wrong object!)
  remove(equation, cal, slope, slope.STD, intercept, intercept.STD, w, model, unique_metal)
```

2) Creating a function to analyze samples
```{r}
#inputs: unique_site (as a character, ex. "A")
#outputs: concentration vector (containing: Metal, site, )

sample_analysis <- function(unique_site){
  concentration_data <- NULL
  for (unique_metal in metals_analyzed){
    sample <- filter(ICPMS, metal == unique_metal, site == unique_site)
    data <- NULL #only necessary for MB 
    
    for(ID in sample$sample.key){ 
      sample_data <- filter(sample, sample.key == ID)
      cal <- filter(ICPMS_cal, metal == unique_metal) 
  
      #Sample Analysis 
      m <- cal$slope 
      b <- cal$intercept 
      y <- sample_data$CPS.corrected
  
      b_e<- cal$intercept.STD
      m_e <- cal$slope.STD
  
      x <- (y-b)/m #The units are dependent on the calibration standards (Kg/mL)
      
      RSD <- sample_data$RSD.corrected
      CPS <- sample_data$CPS.corrected
  
      #Error Propagation
      e_yb <- sqrt((RSD)^2 + (b_e)^2) 
      #error in y-b from the calibration
      yb <- CPS-b
      e_x <- x*sqrt((e_yb/yb)^2+(m_e/m)^2)
      #error in x from the calibration
      
      data <- rbind(data, data.frame(sample.key = ID, x, e_x)) #storing for MB purposes
      if (unique_site != "MB"){
        concentration_data <- data.frame(sample.key = sample_data$sample.key,
                                         analyst = sample_data$analyst,
                                         metal = unique_metal,
                                         site = unique_site,
                                         conc.dil = x, 
                                         conc.dil.error = e_x)%>%
                              rbind(concentration_data)
      }
    }
    if (unique_site=="MB"){
      x <- mean(data$x)
      e_x <- sd(data$x)
      concentration_data <- data.frame(metal = unique_metal,
                                     site = unique_site, 
                                     conc.dil = x,
                                     conc.dil.error = e_x) %>%
                            rbind(concentration_data)
    }
  }
  return(concentration_data)
}

```

3) Creating a run_sites function
```{r}
#inputs: a function
#outputs: a data frame with the function outputs from each site
run_sites <- function(Function){
  value <- NULL
  for(sites in sample_sites){
    site_value <- Function(sites)
    value <- rbind(site_value, value)
  }
  return(value)
}
```

4) Calibrate the data, perform a method blank, and correct for dilution)

```{r}
#1) Calibrate data
MB <- sample_analysis("MB") #(ug/kg)

uncor_sample <- run_sites(sample_analysis) #values do not account for dilutions (ug/kg)
keys <- unique(uncor_sample$sample.key) #sample.keys that correspond to actual samples! 
#(i.e. not QC, MB)

MB
uncor_sample
keys
```

```{r}
#2) Method Blank
sample_data_mb <- NULL

for (unique_metal in metals_analyzed){
  MB_metal <- filter(MB, metal==unique_metal)
  sample_metal <- filter(uncor_sample, metal==unique_metal)
  conc.dil.blanked <- sample_metal$conc.dil-MB_metal$conc.dil
  
  #Error Propagation: subtraction of MB
  conc.dil.blanked.error <- sqrt((sample_metal$conc.dil.error)^2 + (MB_metal$conc.dil.error)^2)
  
  sample_data_mb <- sample_metal %>% 
    mutate(conc.dil.blanked, conc.dil.blanked.error)%>%
    rbind(sample_data_mb)
}

sample_data_mb
```

#Sample Prep Procedure

1) mass.soil (example: 1.50621) weighed on analytical balance (uncertainty = ±.001)
*Note: because the analytical lab has two different types of balances, and the uncertainty was not recorded in the data collection we must assume that everyone used the less precise balance*

2) mass.soil was dried in 55˚C oven for 1 week

3) mass.soil was ground with mortar and pestle

4) mass.soil was quantitatively transferred to acid washed teflon beaker (do steps 2-4 affect uncertainty?)

5) mass.soil was digested with ~10 mL MQ water, 3 mL nitric acid, 2 mL hydrochloric acid and heated till steaming for 30 minutes.

*Note: additional 3 mL nitric and 2 mL hydrochloric were added to prevent rxn from running dry*

6) Acid digestion solution was quantitatively transferred to falcon tube and diluted to total.volume which was measured with fill line (example 45 mL) (uncertainty= 1 mL?)

*How could you improve the precision at this step?*

7) Falcon tube centrifuged for 10 minutes at 1500 rpm for 10 min.

8) 10 mL of sample transferred to metals-free 15 mL tube and brought to OHSU for ICPMS analysis. 
(stored in fridge prior to transport)

9) 10 µL (uncertainty= ± 1µL) of of solution was micro-pipetted into 1000 µL (uncertainty= )of MQ water by Lab Assistant at OHSU. 


```{r}
#error propagation
vol_e <- 1
mass_e <- .001
dil_1010_e <- sqrt(1^2 + 10^2) 
dil_e <- sqrt((dil_1010_e/1010)^2+(1/10)^2) #error in 101 dilution factor

#3) Correct for dilution
sample_data <- merge(ICPMS,sample_data_mb)%>% #This adds in important details such as soil mass
  unique()%>%
  mutate(conc.blanked= conc.dil.blanked*(total.volume/1000)/(mass.soil/1000)*101,
      #101 is the factor diluted by at OHSU to make the solutions dilute enough to run ICPMS on.
           conc.blanked.error = conc.blanked* 
           sqrt((conc.dil.blanked.error/conc.dil.blanked)^2+
                  (dil_e/101)^2 +
                  (mass_e/mass.soil)^2+ 
                  (vol_e/total.volume)^2),
         conc.unblanked = conc.dil*(total.volume/1000)/(mass.soil/1000)*101,
         conc.unblanked.error = conc.unblanked* 
           sqrt((conc.dil.error/conc.dil)^2+
                  (dil_e/101)^2 +
                  (mass_e/mass.soil)^2+ 
                  (vol_e/total.volume)^2))%>%
  select(-concentration, #removing unecesssary columns
         -type, 
         -mass.soil,
         -total.volume,
         -CPS.corrected,
         -RSD.corrected,
         -CPS,
         -RSD,
         -conc.dil.blanked, 
         -conc.dil.blanked.error, 
         -conc.dil,
         -conc.dil.error)

sample_data
```
#What other errors could potentially contribute to the true uncertainty in the final concentrations? 
#Would you expect any of them to be large enough to impact the uncertainty? 

```{r, warning= FALSE}
remove(
  #Data
       MB_metal, 
       MB,
       ICPMS_cal,
       sample_data_mb,
       sample_metal, 
       uncor_sample,
  #Values     
       unique_metal, 
       conc.dil.blanked, 
       conc.dil.blanked.error,
       dil_1010_e,
       dil_e,
       keys,
       mass_e,
       vol_e,
  #functions
       sample_analysis,
       run_sites)
```

#See file 3 for the ICPMS results (statistical analysis and visualization) example code!