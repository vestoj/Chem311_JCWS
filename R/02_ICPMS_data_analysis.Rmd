---
title: 'Data Tidying: ICPMS'
author: "James Vesto"
date: "12/16/2019"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)
```

```{r}
#Note! Before running this file you must run file 1 (01_ICPMS_data_tidying.Rmd)
ICPMS
```

1) Start by defining useful lists; such as what sites, metals, and sample IDs were analyzed.

```{r}
sites_analyzed <- ICPMS %>% 
  select(site)%>%
  unique()%>%
  filter(site!= "QC", site!="MB", site!="")#excluding method blank and quality control from the list of sites


metals_analyzed <- unique(ICPMS$metal)
sample_IDs <- unique(ICPMS$sample.key)

#Preview the lists to check for potential issues:
#sites_analyzed #Note: this is actually a data frame with only one column!
#metals_analyzed
#sample_IDs
```

2) Calibrating the ICPMS Data

```{r Calibration}

ICPMS_cal <- NULL

for (unique_metal in metals_analyzed){

  cal <- ICPMS %>% 
      filter(type == "Cal1" | type== "Cal2" | type == "Cal3") %>% 
      filter(metal == unique_metal) %>%
      select(conc = concentration, signal = CPS.corrected, RSD = RSD.corrected) #(Kg/mL)

  w <- 1/(cal$signal*cal$RSD)^2 
  model <- lm(cal$signal ~ cal$conc, weights= w)

  slope <- model$coefficients[2]
  intercept <- model$coefficients[1]
  slope_STD <- summary(model)$coefficients[2,2]
  intercept_STD <- summary(model)$coefficients[1,2]

  plot(cal$signal ~ cal$conc,
      xlab= paste("Concentration of ", unique_metal,"(ppb)"),
      ylab= "Counts per second")+ 
      abline(model, col="red")+ 
      title(paste("Calibration for", unique_metal)) 

  equation <- data.frame(metal= unique_metal, slope, slope_STD, intercept, intercept_STD)
  ICPMS_cal <- rbind(ICPMS_cal, equation)
  }

  ICPMS_cal 
  
  #Clearing the environment (optional, but helps to prevent accidentally using the wrong object!)
  remove(equation, cal, slope, slope_STD, intercept, intercept_STD, w, model, unique_metal)
```



