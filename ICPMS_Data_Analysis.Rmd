---
title: 'Data Tidying and Analysis: ICPMS'
author: "James Vesto"
date: "12/16/2019"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
#This is the setup chunk
knitr::opts_chunk$set(echo = TRUE)
#The two packages being used in this code are tidyverse and readr, both are available on CRAN and can be installed if necessary with the following lines of code:

#install.packages("tidyverse")
#install.packages("readr")

#loading the libraries
library(tidyverse)
library(readr)
```

#Data Tidying

2) Tidying the RSD Data
```{r Tidying RSD Data, warning=FALSE, message=FALSE}
#This code chunk tidies the ICPMS RSD data
#this is done separately from the overall data tidying to ensure the RSD values 
#are properly matched to the correct sample reading (CPS)

RSD_Data<-ICPMS_Imported %>%
  #first the RSD columns are selected and renamed with the appropriate metal isotope
  select(Cr52 ='CPS RSD', 
         Cr53 ='CPS RSD_1', 
         As75 ='CPS RSD_2', 
         Cd111 ='CPS RSD_3', 
         Cd114 ='CPS RSD_4', 
         Pb208='CPS RSD_5',
         Ge72 ='CPS_7',
         'Sample Key')%>% 
  #The sample key is also selected for later use in verifying 
  #that the RSD data is properly matching the CPS Data
  
  #then the newly renamed RSD columns are gathered together and 
  #a column is created to indicate which metal corresponds to which RSD
  gather(Cr52, Cr53, As75, Cd111, Cd114, Pb208, Ge72, key = "Metal", value = "RSD")%>%
  
  #Then the RSD values are mutated to insure that they are in a numeric format,
  #this helps prevent type related errors
  mutate(RSD=as.numeric(RSD))

#Previewing the Tidy RSD Data
RSD_Data
```

3) Tidying the CPS Data
```{r CPS ICPMS Tidying}
#Tidying the CPS Data for ICPMS and combining back in the RSD data
ICPMS_Tidy <- ICPMS_Imported %>% 
  
  #Starting with renaming all of the CPS data with the appropriate metal
  rename(Cr52 = CPS,
         Cr53 = CPS_1,
         As75 = CPS_2,
         Cd111 = CPS_3,
         Cd114 = CPS_4,
         Pb208 = CPS_5,
         Ge72 = CPS_7)%>% 
  #Next gathering the CPS data and creating a column that indicates the coressponding metal 
  gather(Cr52, Cr53, As75, Cd111, Cd114, Pb208, Ge72, key= "Metal", value="CPS")%>% 
  
  #Selecting the relevant columns 
  #this can be adjusted to fit the data analysis being performed
  select('Sample Key', Metal, CPS)%>% 
  
  #mutating in the RSD data
  mutate(RSD = RSD_Data$RSD)


#Confirming that the RSD data properly matches the CPS data
#Should output TRUE if the data is properly matching 
all(RSD_Data$'Sample Key'==ICPMS_Tidy$'Sample Key', RSD_Data$Metal==ICPMS_Tidy$Metal)

#Previewing the ICPMS Data
ICPMS_Tidy
```

4) Merging in the Sample Key
```{r merging sample key}
#Merging together the ICPMS Data and the Sample Key
ICPMS_Merged <- merge(ICPMS_Tidy, Sample_Key_Imported)

#Previewing the merged data
ICPMS_Merged
```

5) Correcting for internal standard
*Incorrect code*
```{r incorrect ISTD correction}
#This was the original attempt for ISTD correction, unfortunately it improperly pairs the ISTD readings to the ICPMS Samples, later code is shown which utilizes a "for loop" to correct this mistake.

#This code shows the danger of oversimplifying the data analysis; that it is important to confirm that the data is properly matching 

#ISTD_Data <- filter(ICPMS_Merged, Metal== "Ge72") 
#Sample_Data <- filter(ICPMS_Merged, Metal!= "Ge72")
#ICPMS_Data <- mutate(Sample_Data, CPS_corrected = Sample_Data$CPS/ISTD_Data$CPS, RSD_corrected = Sample_Data$RSD/ISTD_Data$RSD)
```

*Correct Code: Utilizes "for loops" to insure proper matching*
```{r ISTD correction}
#This code chunk also performs the ISTD correction, however it uses a for loop to insure proper matching of ISTD to sample reading
#Note: There is a Ge72 CPS value for each sample key and the correct code sorts by Sample Key when subtracting the ISTD CPS Value

##Designing a "for loop"

#1) assign a blank dataframe; this allows the data to be combined together between iterations of the loop
Data_ICPMS <- NULL #This creates a blank dataframe for which the corrected data can be added to!


#2) Find the unique iterations in the Sample Key
unique_IDs <- unique(ICPMS_Merged$`Sample Key`)

#3) Start the for loop 
for(ID in unique_IDs){
  #This loop performs the ISTD correction for each sample key and 
  #then adds the corrected data together between iterations

  #4) Filter the sample data for ISTD data and by each iteration in the unique Sample Keys
  #Note: The ISTD Data should ONLY consist of unique Sample Keys
  
  ISTD <- filter(ICPMS_Merged, Metal == "Ge72", `Sample Key`==ID)
  Sample <- filter(ICPMS_Merged, Metal != "Ge72",`Sample Key`==ID)
  
  #5) Correct the CPS and RSD readings
  corrected <- mutate(Sample,
                      CPS_corrected = Sample$CPS / ISTD$CPS,
                      RSD_corrected = Sample$RSD / ISTD$RSD)
  
#6) Bind together the Corrected data
  Data_ICPMS <- rbind(Data_ICPMS, corrected)
}

#7) Preview the Corrected Data
Data_ICPMS

#all(Data_ICPMS==ICPMS_Data) #This proves the original CPS correction code does not properly match the ISTD CPS readings to the Sample CPS readings! output= FALSE shows that the data improperly matches!! 
```
